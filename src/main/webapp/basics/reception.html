<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>管理接待信息</title>

		<link rel="stylesheet" href="../layui/css/layui.css" media="all">
		<link href="../css/common.css" rel="stylesheet" />
		<style type="text/css">
			.xunjian {
				opacity: 1 !important;
			}

			.layui-btn.xunjian {
				cursor: default;
			}

			.choujian {
				opacity: 1 !important;
			}

			.layui-btn.choujian {
				cursor: default;
			}

			.zuyuan {
				opacity: 1 !important;
			}

			.zuzhang {
				opacity: 1 !important;
			}

			.layui-layedit {
				border-width: 0px;
				border-style: solid;
				border-radius: 2px;
			}

			.layui-layedit-tool {
				padding: 0px;
				border-bottom-width: 1px;
				border-bottom-style: solid;
				font-size: 0;
			}

			.padding_lr_10 {
				padding: 0 !important;
			}

			.padding_lr_10 input {
				border: 0;
			}

			.layui-form-checkbox {
				position: relative;
				height: 30px;
				line-height: 28px;
				margin-right: 10px;
				padding-right: 30px;
				border: 1px solid #d2d2d2;
				cursor: pointer;
				font-size: 0;
				border-radius: 2px;
				-webkit-transition: .1s linear;
				transition: .1s linear;
				box-sizing: border-box;
				width: 60px;
			}

			.layui-unselect.layui-form-switch {
				margin-top: 1px;
				margin-left: 10px;
			}
		</style>
		<style>
			.layui-table-cell {
				height: auto;
			}
			.layui-form-select dl {
		    	max-height: 200px !important;
			}
		</style>
	</head>

	<body class="yfs-list">
		<div class="yfs-body layui-form">
			<div class="yfs-body-search">
				<div class="layui-form-item">
					<!--预订编号-->
					<div class="layui-inline" style="width: 300px;">
						<label class="layui-form-label">预订编号：</label>
						<div class="layui-input-inline">
							<input id="search_houseno" style="width: 180px;" type="text" name="" autocomplete="off" class="layui-input"
							 maxlength="25">
						</div>
					</div>
					<!--房间编号-->
					<div class="layui-inline" style="width: 250px;">
						<label class="layui-form-label">房间编号：</label>
						<div class="layui-input-inline" style="margin-right: 0px !important;width: 140px;">
							<input id="search_title" style="width: 180px;" type="text" name="" autocomplete="off" class="layui-input"
							 maxlength="25">
						</div>
					</div>
					<!--预订日期-->
					<div id="ywy" class="layui-inline" style="width: 300px;">
						<label class="layui-form-label">预订日期：</label>
						<div class="layui-input-inline" style="width: 150px;">
							<input type="text" class="layui-input" id="test1">
						</div>
					</div>
					<!--搜索-->
					<div class="layui-inline">
						<button class="layui-btn layui-btn-small layui-btn-normal" onclick="getSearchData()"><i class="layui-icon">&#xe615;</i>
							检索</button>
					</div>
				</div>
			</div>

			<div class="yfs-body-button">
				<button class="layui-btn layui-btn-sm layui-bg-blue" onclick="addView()"><i class="layui-icon">&#xe654;</i> 添加订房信息</button>
				<button class="layui-btn layui-btn-sm layui-bg-orange" onclick="modView()"><i class="layui-icon">&#xe642;</i>
					修改订房信息</button>
				<button class="layui-btn layui-btn-sm layui-bg-red" onclick="getdel()"><i class="layui-icon">&#xe640;</i> 删除订房信息</button>
				<button class="layui-btn layui-btn-sm layui-bg-green" onclick="setOut()"><i class="layui-icon">&#xe605;</i> 预订转接待</button>

				<div style="clear: both;"></div>
			</div>

			<div class="yfs-body-table">
				<table class="layui-table" lay-data="{id:'demo'}" lay-filter="demo">
					<thead>
						<tr style="text-align: center;" class="layui-bg-orange">
							<th lay-data="{field:'id', width:60,checkbox:true,fixed:true }"></th>
							<th lay-data="{field:'houseno',width:180}" style="text-align: center;">房源编号</th>
							<th lay-data="{field:'title',width:180}" style="text-align: center;">标题</th>
							<th lay-data="{field:'address'}" style="text-align: center;">地址</th>
							<th lay-data="{field:'price',width:150}" style="text-align: center;">价格</th>
							<th lay-data="{field:'soldflg',width:150}" style="text-align: center;">出售状况</th>
							<th lay-data="{field:'total_area',width:100}" style="text-align: center;">总面积</th>
							<th lay-data="{field:'salesuser',width:100}" style="text-align: center;">业务员</th>
							<!--<th lay-data="{field:'validity',width:140}" style="text-align: center;">截止日期</th>-->
						</tr>
					</thead>
					<tbody id="datalist" lay-filter="test">
					</tbody>
				</table>
				<div id="pageDiv">
					<div id="page" class="layui-table-tool"></div>
				</div>

				</table>
			</div>
		</div>

		<script id="view" type="text/html">
			{{# layui.each(d, function(index, item){ }}
				<tr >
				<!--//编号-->
				<td>{{ item.house_id }}</td>
				<!--//房源编号-->
				<td><span style="cursor: pointer;color: blue;" data-id="{{ item.house_id}}" onclick="getComms(this)"> {{ item.house_no }} </span></td>
				<!--//标题-->
				<td>{{ item.title }}</td>
				<!--//地址-->
				<td>{{item.address}}</td>
				<td>{{item.price}}{{item.unit}}</td>
				<td>{{item.soldflg==1?'已售':'未售'}}</td>
				<td>{{item.totalarea}}</td>
				<td>{{item.salename}}</td>
			</tr>
			{{# }); }}
		</script>
		<script src="../js/jquery-3.3.1.min.js"></script>
		<script src="../layui/layui.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/common.js" type="text/javascript"></script>
		<script>
			// 验证非法登录
			//checkLogin();
		</script>
		<script>
			layui.use(['laypage', 'layer', 'form', 'laytpl', 'table', 'laydate'], function() {
							laypage = layui.laypage;
								layer = layui.layer;
								laytpl = layui.laytpl;
								form = layui.form;
								laydate = layui.laydate;
								table = layui.table;
							//执行一个laydate实例
							laydate.render({
								elem: '#test1' //指定元素
							});
							//权限判断 是业务员就隐藏基本设置
							if(getCookie('flg') == '0') {
								$('#ywy').hide();
								//$('.setYwy').hide();
							}
							
							//获取业务员信息
							updataPep();
							//检索
							getSearchData();
							form.render();
						});
			
						$(window).resize(function() {
							var tempheight = $(document).height() -
								$(".yfs-body-search").outerHeight(true) -
								$(".yfs-body-button").outerHeight(true) -
								$("#pageDiv").outerHeight(true);
							table.init('demo', {
								height: tempheight,
								limit: pageSize
							});
						});
						//获取业务员
						function updataPep() {
							$.ajax({
								type: "post",
								url: '/ESFWeb/api/getadmin.jsp',
								datatype: 'json',
								data: {
									admintype: admintype,
									adminid: adminid,
									adminkey: adminkey
								},
								success: function(e) {
									console.log('查询成功之后')
									var Data = e;
									checkError(Data);
									console.log(Data)
									var inner = '<option value="">请选择业务员</option>'
									Data.body.forEach(function(q) {
										inner += '<option value="' + q.user_id + '">' + q.user_name + '</option>'
									})
									document.getElementById('querybyywy').innerHTML = inner
									form.render('select');
								},
								error: function(e) {
									console.log('查询失败')
									console.log(e)
								}
							})
						}
						
						/**
						 * 检索
						 */
						function getSearchData() {	
							// 页码重置
							pageIndex = 1;
							// 获取数据
							getData();
						};
						
						//获取数据
						function getData() {
							//房源编号
							var search_houseno=$("#search_houseno").val().toString().trim();
							//厂房标题
							var search_title=$("#search_title").val().toString().trim();
							//业务员
							var salesuser = $('#querybyywy').val();
							
							//判断用户权限 如果是管理员不上传id，是业务员就上传业务员id
							if(getCookie('flg')=='1'){
								var salesid=''
							}else{
								var salesid=adminid
							}
							
							// 是否已出租标记
							/* var soldflg = $('#soldflg').val(); */
							
							$.ajax({
					            	type:"post",
					            	url:'/ESFWeb/house/select/all.jsp',
					            	datatype:'json',
					            	data:{
					            		admintype:admintype,
					            		adminid:adminid,
					            		adminkey:adminkey,
					            		pageIndex:pageIndex,
					            		pageSize:pageSize,
					            		//房源编号
					            		houseno:search_houseno,
					            		//厂房标题
					            		title:search_title,
					            		//业务员
					            		salesuser:salesuser,
					            	},
					            	success:function(data){
					            		var newData=data;
					            		console.log(newData)
								    	// 获取容器
										var tables = $("#datalist");
								    	//得到html模板
										var getTpl = document.getElementById("view").innerHTML;
								    	//插入html模板
								    	laytpl(getTpl).render(newData.body, function(html) {
											tables.html(html);
										});
										
										// 分页
										//createPage(newData.page.totalCount);
					            		// 计算表格高度
										var tempheight = $(document).height() -
											$(".yfs-body-search").outerHeight(true) -
											$(".yfs-body-button").outerHeight(true) -
											$("#pageDiv").outerHeight(true);
										table.init('demo', {
											height: tempheight,
											limit: pageSize
										});
										
										var now = new Date().Format("yyyy-MM-dd"); 
										
										for(var i = 0; i < newData.body.length; i++) {
											// 置顶的变色
											if(newData.body[i].topflg == "1") {
												$('.layui-table tbody tr:nth-child(' + (i + 1) + ')').css("background-color", "#5FB878");
											}
											// 已出售的变色
											if(newData.body[i].soldflg == "1") {
												$('.layui-table tbody tr:nth-child(' + (i + 1) + ')').css("background-color", "#c2c2c2");
											}
										}
										
										form.render();
					            	},
					            	error:function(e){
					            		console.log(e)
					            	}
					            });
						}	
						
					 	//置顶
					 	function stick(){
					 		//获取选中的guid
					 		var checkStatus = table.checkStatus('demo'),
							data = checkStatus.data;
							
							if(data.length == 0) {
								layer_msg("请选择需要置顶的房源！");
								return;
							}
							
							var guids=''
							data.forEach(function(e){
								guids+=e.id+','
							})
							console.log(guids)
							var formData=new FormData()
							formData.append('guid',guids)
							formData.append('admintype',admintype)
							formData.append('adminid',adminid)
							formData.append('adminkey',adminkey)
							//发起请求
							commonAjax(URL_pc_factory_settop,formData,"post", true, function(e){
								console.log(e)
								if(e.key=='SUCCESS'){
									getSearchData()
								}else{
									alertWarning(e.msg)
								}
							})
					 	}
					 	
						//修改视图
						function modView(){
							//获取选中的guid
							var checkStatus = table.checkStatus('demo'),
							data = checkStatus.data;
							console.log(data)
							if(data.length == 1) {
								//当前选中的guid
								var guid=data[0].id
								console.log(guid)
									pageOpen("房源信息修改", "modhouse.html", guid, "95%", "90%");
							} else if(data.length == 0||data.length > 1) {
								layer_msg("请选择一条数据修改！");
								return;
							}				
						}
						
						//添加	
						function addView(){				
							pageOpen("房源新增", "addreservation.html", "0", "95%", "90%");
						}
						//关闭遮罩层，刷新数据
			//			function upd(){
			//				getData()
			//			}
						//删除视图
						function delHouse(id){
							$.ajax({
								type: "post",
								url: '/ESFWeb/house/delete.jsp',
								datatype: 'json',
								data: {
									house_id:id
								},
								success: function(data) {
									var newData = data;
									console.log(newData)
									if(newData.key=='SUCCESS'){
										alertSuccess("房源信息删除成功");
										getData();
									}else{
										layer_msg("房源信息删除失败");
										getData();
									}
								},
								error: function(e) {
									console.log(e)
								}
							});
						}
						//删除
						function getdel(){
							var checkStatus = table.checkStatus('demo'),
								data = checkStatus.data;
								if(data.length >= 1) {
									var id = "";
									for(var i = 0; i < data.length; i++) {
										id = id + data[i].id + ",";
									}
									if(id.length > 0) {
										id = id.substr(0, id.length - 1);
										// 弹出提示框
										console.log(id)
										layer.confirm('您确定要删除这些信息吗?', {
											icon: 3,
											title: '删除'
										}, function(index) {
											delHouse(id);
											// 关闭提示框
											layer.close(index);
										});
									}
								} else if(data.length == 0) {
									layer_msg("请选择一条数据！");
									return;
								}
						}
						
						//指定业务员
						function setYwy(){
							var checkStatus = table.checkStatus('demo'),
							data = checkStatus.data;
							
							if(data.length >= 1) {
								var fid = "";
								for(var i = 0; i < data.length; i++) {
									fid = fid + data[i].id.split(",")[0] + ",";
								}
								if(fid.length > 0) {
									fid = fid.substr(0, fid.length - 1);
									// 打开指定业务员页面
									pageOpen("指定业务员", "setYwy.html?fid="+fid, null, "80%", "70%");
								}
							} else if(data.length == 0) {
								layer_msg("请选择一条数据！");
								return;
							}
						}
						
						function uplist(){
							layer.closeAll()
							getSearchData()
							alertSuccess('操作成功！')
						}
						
						// 打开房源详情
						function getComms(e) {
							var guid = $(e).data("id");
							pageOpen("房源详情", "housedetail.html", guid, "95%", "90%");
						}
						
						// 设置房源已出售
						function setOut(){
							//获取选中的guid
							var checkStatus = table.checkStatus('demo'),
							data = checkStatus.data;
							if(data.length == 1) {
								//当前选中的guid
								var guid = data[0].id;
								//执行更新出售状态
								sold(guid)
							} else if(data.length == 0||data.length > 1) {
								layer_msg("请选择一条数据！");
								return;
							}
						}
						//出售状态
						function sold(id){
							$.ajax({
								type: "post",
								url: '/ESFWeb/house/sold.jsp',
								datatype: 'json',
								data: {
									house_id:id
								},
								success: function(data) {
									var newData = data;
									console.log(newData)
									if(newData.key=='SUCCESS'){
										alertSuccess("设置出售状态成功");
										getData();
									}else{
										layer_msg("设置出售状态失败");
										getData();
									}
								},
								error: function(e) {
									console.log(e)
								}
							});
						}
						
		</script>
	</body>

</html>
