<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>个人信息</title>
		<link rel="stylesheet" href="../layui/css/layui.css" media="all">
		<link href="../css/common.css" rel="stylesheet" />
	</head>
	<body>
		<table class="layui-table">
			<thead>
				<tr>
					<th colspan="3">个人信息</th>
				</tr>
			</thead>
			<tbody id="datalist" lay-filter="test">
			</tbody>
		</table>
		<div style="display: flex;justify-content: center;"><button class="layui-btn layui-btn-normal" onclick="updatePwd()">修改个人信息</button></div>
		<script id="view" type="text/html">
			{{# layui.each(d, function(index, item){ }}
				<tr >
					<td>用户名</td>
					<td><input class="layui-input" value="{{ item.user_name }}" type="text" id="user_name"></td>
				</tr>
				<tr>
					<td>联系方式</td>
					<td><input id="user_phone" value="{{item.user_phone}}" class="layui-input" type="number"></td>
				</tr>
				<tr>
					<td>用户类型</td>
					<td><input value="{{item.flg == 1?'管理员':'经纪机构用户' }}"  id="flg" class="layui-input" autocomplete="on"></td>
				</tr>
			{{# }); }}
		</script>
		<script src="../js/jquery-3.3.1.min.js"></script>
		<script src="../layui/layui.all.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/common.js" type="text/javascript"></script>
		<script>
			// 验证非法登录
			//checkLogin();
		</script>
		<script>
			// 用户名
			var user_name = ""
			// 联系电话
			var user_phone=''
			//用户类型
			var flg =""
			//pc类型
			var admintype=getCookie('admintype')
			//id
			var adminid=getCookie('adminid')
			//key
			var adminkey=getCookie('adminkey')
			
			layui.use(['laypage', 'layer', 'form', 'laytpl', 'table', 'laydate'], function() {
				laypage = layui.laypage;
					layer = layui.layer;
					laytpl = layui.laytpl;
					form = layui.form;
					laydate = layui.laydate;
					table = layui.table;
					getData()
				form.render();
			});
			//获取数据
			function getData() {
				var user_id = GetQueryString("id")
				console.log(user_id)
				$.ajax({
			        	type:"post",
			        	url:'/ESFWeb/api/getAdminById.jsp',
			        	datatype:'json',
			        	data:{
			        		admintype:admintype,
			        		adminid:adminid,
			        		adminkey:adminkey,
							user_id:user_id
			        	},
			        	success:function(data){
			        		var newData=data;
			        		checkError(newData);
			        		console.log(newData)
					    	// 获取容器
							var tables = $("#datalist");
					    	//得到html模板
							var getTpl = document.getElementById("view").innerHTML;
					    	//插入html模板
					    	laytpl(getTpl).render(newData.body, function(html) {
								tables.html(html);
							});
							
							form.render();
			        	},
			        	error:function(e){
			        		console.log(e)
			        	}
			        });
			}	
			function updatePwd(){
				var user_id = GetQueryString("id")
				// 用户名
				user_name = $("#user_name").val().toString().trim();
				//联系电话
				user_phone=$("#user_phone").val().toString().trim();
				//用户类型
				var flgtype = $("#flg").val().toString().trim();
				if(flgtype == "管理员"||flgtype == "经纪机构用户"){
					if(flgtype == "管理员"){
						flg = 1
					}
					if(flgtype == "经纪机构用户"){
						flg = 0 
					}
				}else{
					alertWarning('请输入正确的用户类型')
					return
				}
				$.ajax({
				    	type:"post",
				    	url:'/ESFWeb/api/update.jsp',
				    	datatype:'json',
				    	data:{
				    		admintype:admintype,
				    		adminid:adminid,
				    		adminkey:adminkey,
				    		user_name:user_name,
				    		user_phone:user_phone,
							flg :flg,
							user_id :user_id
				    	},
				    	success:function(data){
				    		//var newData=JSON.parse(data);
							var newData = data
				    		layer.alert(newData.msg,{
				    			icon:1,
				    			closeBtn:0
				    		},function(index){
				    			//关闭保存成功页面
				    			layer.close(index);
				    			//获得当前页面索引
				    			var indexmain = parent.layer.getFrameIndex(window.name);
				    			//触发主页面按钮事件,根据不同业务可以在自己页面中修改方法
				    			parent.getSearchData()
				    			parent.layer.close(indexmain)
				    		})
				    	},
				    	error:function(e){
				    		layer.alert(e.msg,{
				    			closeBtn:0
				    		},function(index){
				    			//关闭保存成功页面
				    			layer.close(index);
				    			//获得当前页面索引
				    			var indexmain = parent.layer.getFrameIndex(window.name);
				    			//触发主页面按钮事件,根据不同业务可以在自己页面中修改方法
				    			parent.getSearchData()
				    			parent.layer.close(indexmain)
				    		})
				    	}
				    });
			}
			
		</script>
	</body>
</html>
